(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["session"],{"0cf6":function(e,t,n){"use strict";var o=n("7086"),r=n.n(o);r.a},7086:function(e,t,n){},"78b4":function(e,t,n){"use strict";n.r(t);var o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("main",[n("h1",[e._v(e._s("Session "+e.$route.params.sessionName))]),e.$route.query.serverUrl?e._e():n("Modal",{attrs:{fixed:"",open:""},on:{close:function(t){return e.$router.replace("/")}},scopedSlots:e._u([{key:"header",fn:function(){return[n("h3",[e._v(e._s("Error !"))])]},proxy:!0}],null,!1,2136969466)},[n("p",[e._v(e._s("A server URL is required."))])]),n("Modal",{attrs:{fixed:"",open:!!e.error},on:{close:function(t){e.error=void 0}},scopedSlots:e._u([{key:"header",fn:function(){return[n("h3",[e._v(e._s("An unknown error occurred"))])]},proxy:!0}])},[n("p",[e._v(e._s("This is the error"))]),e.error?n("pre",[e._v("      "+e._s(e.error.message)+"\n      "+e._s(e.error.stack)+"\n    ")]):e._e()]),n("Modal",{attrs:{fixed:"",open:e.unableToReachServer},on:{close:function(t){e.unableToReachServer=void 0}},scopedSlots:e._u([{key:"header",fn:function(){return[n("h3",[e._v("Oopsie…")])]},proxy:!0}])},[n("p",[e._v("Looks like the server is taking a nap, we can’t reach it…")])]),e.canJoinSession?e.isLocalPeerSetupReady?n("div",[n("h3",[e._v("Conference "+e._s(e.$route.params.sessionName))]),n("video",{key:"local-peer-video",ref:"local-peer-video",attrs:{playsinline:"",autoplay:"",muted:""},domProps:{muted:!0}}),e.peersManager?n("span",{staticStyle:{display:"inline-block"}},e._l(e.peersManager.peerConnections.keys(),(function(e){return n("video",{key:e,ref:e,refInFor:!0,attrs:{playsinline:"",autoplay:""}})})),0):e._e()]):n("div",[n("ul",{staticStyle:{"text-align":"left","line-height":"2.5em"}},[n("h3",{staticStyle:{margin:"0"}},[e._v("Before joining the session:")]),n("li",[e._v("Accept sharing your audio & video with this us.")]),n("li",[e._v("Check out your video (below) to see if everything is OK.")]),n("li",[e._v("If necessary, you can "),n("button",{on:{click:e.askLocalStream}},[e._v("Re-ask to get your audio & video")])])]),n("div",[n("video",{key:"local-peer-video",ref:"test-video",attrs:{playsinline:"",autoplay:"",muted:""},domProps:{muted:!0}})]),n("div",{staticStyle:{padding:"2em 0"}},[n("button",{attrs:{disabled:!e.localStream},on:{click:e.finishInitialSetup}},[e._v("Let’s go to that conference call")])])]):n("div",[n("h3",[e._v("Let’s initialize that session dude.")]),e.joinSessionLoading?n("div",[e._v(" Joining the session… ")]):e._e(),n("Modal",{attrs:{fixed:"",open:!1===e.canJoinSession},on:{close:function(t){return e.$router.replace("/")}},scopedSlots:e._u([{key:"header",fn:function(){return[n("h3",[e._v("Aïe aïe aïe")])]},proxy:!0}],null,!1,3527552773)},[n("p",[e._v(" You cannot join this session. Either this session does not exist, either the URL you were given is wrong. ")])])],1)],1)},r=[],i=n("12fd"),s=n("714b");function a(e,t,n,o){function r(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o["throw"](e))}catch(t){i(t)}}function c(e){e.done?n(e.value):r(e.value).then(s,a)}c((o=o.apply(e,t||[])).next())}))}function c(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(e){return function(t){return c([e,t])}}function c(i){if(n)throw new TypeError("Generator is already executing.");while(s)try{if(n=1,o&&(r=2&i[0]?o["return"]:i[0]?o["throw"]||((r=o["return"])&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(r=s.trys,!(r=r.length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(a){i=[6,a],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}}var l=[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"turn:137.74.113.202:3478",username:"azfne",credential:"oegiojre"}],d=function(){function e(e){var t=this;this.localPeerId=e.localPeerId,this.remotePeerId=e.remotePeerId,this.socketAPI=e.socketAPI,this.connection=new RTCPeerConnection({iceServers:l}),this.remoteStream=null,this.remotePeerVideo=null,e.localStream.getTracks().map((function(n){return t.connection.addTrack(n,e.localStream)})),this.registerICECandidatesListener(),this.connection.addEventListener("track",(function(e){t.remoteStream=e.streams[0],t.remotePeerVideo&&(t.remotePeerVideo.srcObject=t.remoteStream)}))}return e.prototype.onClose=function(e){var t=this;return this.connection.addEventListener("connectionstatechange",(function(n){switch(console.debug("connection state change",n,"connection state:",t.connection.connectionState),t.connection.connectionState){case"closed":case"disconnected":case"failed":e(n);break;default:break}})),this},e.prototype.registerVideo=function(e){return this.remotePeerVideo=e,this.remoteStream&&(this.remotePeerVideo.srcObject=this.remoteStream),this},e.prototype.registerICECandidatesListener=function(){var e=this;return this.connection.addEventListener("icecandidate",(function(t){t.candidate&&(console.debug("emit ICE candidate to",e.remotePeerId,t.candidate),e.socketAPI.send({type:"ice-candidate",candidate:t.candidate,fromPeerId:e.localPeerId,toPeerId:e.remotePeerId}))})),this.socketAPI.onIceCandidate((function(t){"ice-candidate"===t.type&&(console.debug(e.localPeerId,"receive ice candidate from",t.fromPeerId,t.candidate),e.connection.addIceCandidate(new RTCIceCandidate(t.candidate)).catch(console.error))})),this.connection.addEventListener("iceconnectionstatechange",(function(t){console.debug("ice connection state change",t,e.connection.iceConnectionState)})),this},e}(),u=(new Map,{offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!0}),h=function(){function e(e){var t=this,n=e.socketAPI,o=e.localPeerId,r=e.localStream;this.socketAPI=n,this.localPeerId=o,this.localStream=r,this.peerConnections=new Map,n.onConnectedPeers((function(e){return t.onConnectedPeers(e)})),n.onOffer((function(e){return t.onOffer(e)})),n.onAnswer((function(e){return t.onAnswer(e)}))}return e.prototype.getPeerConnection=function(e){var t=this.peerConnections.get(e);if(!t)throw new Error("No peer connection with remote peer "+e);return t},e.prototype.closeAllConnections=function(){this.socketAPI.close()},e.prototype.onConnectedPeers=function(e){var t=this;if("connected-peers-id"!==e.type)throw new Error("Invalid connected peers message");var n=e.peerIds.filter((function(e){return e!==t.localPeerId})).map((function(e){return a(t,void 0,void 0,(function(){var t,n;return c(this,(function(o){switch(o.label){case 0:return t=new d({localPeerId:this.localPeerId,remotePeerId:e,localStream:this.localStream,socketAPI:this.socketAPI}),this.peerConnections.set(e,t),[4,t.connection.createOffer(u)];case 1:return n=o.sent(),[4,t.connection.setLocalDescription(n)];case 2:return o.sent(),this.socketAPI.send({type:"offer",description:n,offererId:this.localPeerId,answererId:e}),[2]}}))}))}));Promise.all(n).catch(console.error)},e.prototype.onOffer=function(e){return a(this,void 0,Promise,(function(){var t,n;return c(this,(function(o){switch(o.label){case 0:if("offer"!==e.type)throw new Error("Invalid offer socket message");return t=this.getPeerConnection(e.offererId),[4,t.connection.setRemoteDescription(e.description)];case 1:return o.sent(),[4,t.connection.createAnswer(u)];case 2:return n=o.sent(),[4,t.connection.setLocalDescription(n)];case 3:return o.sent(),this.socketAPI.send({type:"answer",answererId:this.localPeerId,offererId:e.offererId,description:n}),[2]}}))}))},e.prototype.onAnswer=function(e){if("answer"!==e.type)throw new Error("Invalid answer socket message");var t=this.getPeerConnection(e.answererId);t.connection.setRemoteDescription(e.description)},e}();function p(){const e=Math.round(1e5*Math.random());return"peer-"+e}var f={name:"Session",components:{Modal:s["a"]},data:()=>({joinSessionLoading:!1,canJoinSession:void 0,unableToReachServer:void 0,error:void 0,isLocalPeerSetupReady:!1,localStream:null,localPeerId:p(),peersManager:null}),async mounted(){const{serverUrl:e,password:t}=this.$route.query,n=new i["ServerAPI"]({url:new URL(e).origin});this.joinSessionLoading=!0,console.info("local peer id",this.localPeerId);try{const e=await n.joinSession(this.$route.params.sessionName,t);this.canJoinSession=e.ok}catch(o){console.error(o),this.unableToReachServer=!0}this.joinSessionLoading=!1,this.canJoinSession&&!this.unableToReachServer&&await this.askLocalStream()},errorCaptured(e){this.error=e},beforeDestroy(){console.info("beforeDestroy()"),this.peersManager&&this.peersManager.closeAllConnections()},methods:{finishInitialSetup(){this.isLocalPeerSetupReady=!0;const{params:{sessionName:e},query:{serverUrl:t}}=this.$route.params,n=new URL(t);n.protocol=window.location.protocol.replace("http","ws");const o=i["SOCKET_ROUTE"].replace("{sessionName}",e).replace("{peerId}",this.localPeerId);this.peersManager=new h({socketAPI:new i["SocketAPI"]({url:new URL(o,n).href,sessionName:this.$route.params.sessionName,peerId:this.localPeer}),localPeerId:this.localPeerId,localStream:this.localStream}),this.$nextTick(()=>{this.registerRemotePeersVideo(),this.$refs["local-peer-video"].srcObject=this.localStream}),this.$watch("peersManager.size",()=>{this.$nextTick(()=>this.registerRemotePeersVideo())})},registerRemotePeersVideo(){this.peersManager.peerConnections.forEach((e,t)=>{e.registerVideo(this.$refs[t])})},async askLocalStream(){const e={echoCancellation:!0,noiseSuppression:!0};this.localStream=await window.navigator.mediaDevices.getUserMedia({audio:e,video:e}),this.$refs["test-video"].srcObject=this.localStream}}},v=f,m=(n("0cf6"),n("2877")),y=Object(m["a"])(v,o,r,!1,null,null,null);t["default"]=y.exports}}]);
//# sourceMappingURL=session.0fac76ae.js.map